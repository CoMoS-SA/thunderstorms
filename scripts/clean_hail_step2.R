library(tidyverse)
library(sf)
library(magrittr)
library(tictoc)
library(tmaptools, warn.conflicts =FALSE)

rm(list = ls())

data <- readRDS(file="data/clean_hail_step1.rds")
county_shape <- st_read("utilities/c_10nv20/") 
zone_shape <- st_read("utilities/z_08mr23/") 
states <- read_csv("utilities/states.csv")

states %<>% 
  mutate(
    State = toupper(State)
  ) %>% 
  rename(STATE=State, STATE_CODE = Abbreviation)

county_shape %<>%
  rename(STATE_CODE=STATE) %>% 
  mutate(COUNTYNAME=toupper(COUNTYNAME)) %>% 
  left_join(
    .,
    states,
    by = "STATE_CODE"
  ) %>% 
  filter(!is.na(STATE)) %>% 
  group_by(FIPS) %>% 
  mutate(
    geometry = st_union(geometry)
  )

county_shape %>% 
  select(-LON, -LAT) %>% 
  duplicated() -> aux

county_shape<- county_shape[!aux,]
remove(aux)

#fix error
data[data$EVENT_ID==10331500, "STATE"] <- "MICHIGAN"
data[data$EVENT_ID==10331500, "STATE_FIPS"] <- 26

data %<>% 
  filter(!(STATE_FIPS%in%c(96,97,98,99))) %>%  #remove puerto rico, american samoa, guam and virgin islands
  left_join(
    .,
    states,
    by = "STATE"
  ) %>% 
  mutate(
    STATE_FIPS = case_when(
      nchar(as.character(STATE_FIPS)) == 1 ~ paste0("0",STATE_FIPS),
      T ~ as.character(STATE_FIPS),
    ),
    CZ_FIPS = case_when(
      nchar(as.character(CZ_FIPS)) == 1 ~ paste0("00",CZ_FIPS),
      nchar(as.character(CZ_FIPS)) == 2 ~ paste0("0",CZ_FIPS),
      T ~ as.character(CZ_FIPS),
    ),
    FIPS_MIX = ifelse(CZ_TYPE=="C",paste0(STATE_FIPS, CZ_FIPS),paste0(STATE_CODE, CZ_FIPS)) 
  )

#remove Hawaii and Alaska
data %<>% 
  filter(STATE!="HAWAII") %>% 
  filter(STATE!="ALASKA")

table(data$CZ_TYPE)

data %>% 
  filter(CZ_TYPE=="C") %>%
  distinct(FIPS_MIX) %>% pull() -> fips_c

data %>% 
  filter(CZ_TYPE=="Z") %>% 
  distinct(FIPS_MIX) %>% pull() -> fips_z

setdiff(fips_z, zone_shape %>% pull(STATE_ZONE))
intersect(fips_z, zone_shape %>% pull(STATE_ZONE)) -> no_prob


data %>% 
  filter(FIPS_MIX %in% no_prob) -> no_prob_z_data

#load zone-county correlation file
# https://www.weather.gov/gis/ZoneCounty
zones_to_county <- read_delim("utilities/zones_to_county.csv", 
                              delim = "|", escape_double = FALSE, col_names = FALSE, 
                              trim_ws = TRUE)

colnames(zones_to_county) <- c("STATE", "ZONE", "CWA", "NAME", "STATE_ZONE", "COUNTY", "FIPS", "TIME_ZONE", "FE_AREA", "LAT", "LON")

zones_to_county %<>% 
  select(STATE_ZONE, COUNTY, FIPS) %>% 
  group_by(STATE_ZONE) %>% 
  summarise(
    COUNTY = list(COUNTY),
    FIPS = list(FIPS)
  )

zone_shape %<>% 
  left_join(
    .,
    zones_to_county,
    by="STATE_ZONE"
  )

#Fix an error
zone_shape[zone_shape$STATE_ZONE=="WY001",]$COUNTY[[1]] <- c("Park", "Teton")
zone_shape[zone_shape$STATE_ZONE=="WY001",]$FIPS[[1]] <- c("56029", "56039")

no_prob_z_data %<>% 
  left_join(
    .,
    zone_shape %>% 
      as_tibble() %>% 
      select(STATE_ZONE, FIPS),
    by = c("FIPS_MIX"="STATE_ZONE")
  )

setdiff(unlist(no_prob_z_data$FIPS), county_shape$FIPS)

data %>% 
  filter(FIPS_MIX %in% fips_c) -> data_c

data_c %<>% 
  mutate(
    FIPS_MIX = case_when(
      FIPS_MIX == "51515" ~ "51019",
      FIPS_MIX == "04029" ~ "04012",
      T ~ FIPS_MIX
    )
  )

setdiff(data_c$FIPS_MIX, county_shape$FIPS)
setdiff(county_shape$FIPS, data_c$FIPS_MIX)

data_c %>% 
  filter(FIPS_MIX %in% county_shape$FIPS) -> data_c_no_prob

data_c %>% 
  filter(!(FIPS_MIX %in% county_shape$FIPS)) -> data_c_prob

data_c_prob %<>% 
  filter(!(CZ_NAME%in%c("NVZ006", "NVZ009", "TXZ511")))

tibble(
  EVENT_ID = c(10156557,10337490,10355688,10316743,10346125,10346126,10346097,10346098,10346110,10328114,10345667,10346149,10346150,10346151,10346152,10357583,10346178,10340240,10357637,10316825,10333439,10331769,10334362,10331771,10329538,10330212,10324928,10346128,10320260,10346123,10346124,10338435,10338438,10338467,10338466,10320594,10335916,10329795,10335897,10335898,10335895,10339714,10340241,10335220,10328169,10334357,10324856,10333440,10333441,10333442,10333464,5388859),
  
  FIPS = list(
    c("56029", "56039"),
    c("38009", "38019", "38067"),
    c("48127", "48131", "48215", "48247", "48249", "48283", "48311", "48427", "48479", "48505", "48047", "48025","48061", "48273", "48355", "48105", "48107", "48111", "48113", "48115", "48117", "48119", "48121", "48123","48125", "48129", "48133", "48135", "48137", "48139", "48143", "48145", "48147", "48149", "48151", "48153","48155", "48157", "48159", "48161", "48165", "48169", "48171", "48173", "48177", "48179", "48181", "48183","48185", "48187", "48189", "48191", "48193", "48195", "48197", "48199", "48203", "48205", "48207", "48209","48211", "48213", "48217", "48219", "48221", "48223", "48225", "48227", "48231", "48233", "48235", "48237","48251", "48253", "48257", "48259", "48263", "48265", "48267", "48269", "48271", "48275", "48277", "48279","48281", "48285", "48287", "48289", "48291", "48293", "48295", "48299", "48301", "48303", "48305", "48307","48309", "48313", "48315", "48317", "48319", "48325", "48327", "48329", "48331", "48333", "48335", "48337","48339", "48341", "48343", "48345", "48347", "48349", "48351", "48353", "48357", "48359", "48363", "48365","48103", "48369", "48371", "48373", "48375", "48379", "48381", "48383", "48385", "48387", "48393", "48395","48397", "48399", "48401", "48403", "48405", "48407", "48411", "48413", "48415", "48417", "48419", "48421","48423", "48425", "48429", "48431", "48433", "48435", "48437", "48439", "48441", "48443", "48445", "48447","48449", "48451", "48453", "48455", "48457", "48459", "48461", "48463", "48465", "48467", "48471", "48473","48475", "48477", "48481", "48483", "48485", "48487", "48491", "48493", "48495", "48497", "48499", "48501","48503", "48087", "48085", "48083", "48081", "48079", "48077", "48075", "48073", "48069", "48067", "48065","48063", "48059", "48055", "48053", "48051", "48049", "48045", "48041", "48037", "48035", "48033", "48031","48029", "48027", "48023", "48021", "48019", "48017", "48015", "48011", "48009", "48005", "48003", "48001","48089", "48245", "48091", "48093", "48095", "48097", "48099", "48101", "48367", "48361", "48039", "48071","48167", "48389", "48109", "48043", "48243", "48377", "48163", "48175", "48255", "48297", "48323", "48507","48013", "48469", "48007", "48409", "48391", "48201", "48141", "48229", "48321", "48241", "48057", "48239","48261", "48489"),
    c("08081", "08103", "08107", "08037", "08045", "08097"),
    "46081",
    "46081",
    "46013",
    "46013",
    c("46081", "46093"),
    c("22057", "22087"),
    c("42049","42049","42039","42123","42083","42105","42085","42121","42053","42047","42023","42035"),
      "46102",
      "46102",
      "46102",
      "46102",
      c("55031", "55013", "55129", "55095", "55005"),
      "46127",
      c("39171","39051","39095","39039","39069","39173","39123","39143","39043","39093","39035","39085","39055","39007","39125","39137","39063","39147","39077","39103","39161","39003","39065","39175","39033","39139","39005","39169","39107","39011","39101","39117","39037","39149","39091","39109","39021","39023","39135","39113","39017"),
      c("55011", "55121", "55141"),
      c("06005", "06009", "06077", "06099", "06109"),
      c("31021", "31053", "31177", "31155", "31055", "31153", "31047", "31019", "31085"),
      c("29005", "29165", "29047", "29095", "29037"),
      c("30029", "30047", "30089"),
      c("29199", "29045", "29103", "29111", "29205", "29127", "29137", "29173", "29163", "29019", "29007", "29135","29051","29151","29027","29139","29113","29073","29219","29183","29071","29189","29510","29099","29161","29055","29221","29187","29186","29157","29065","29093","29123","29179"),
      c("25001", "25007"),
      c("28153", "28111", "28041"),
      c("21143", "21221", "21033"),
      c("46005", "46111", "46035", "46061", "46067", "46009", "46135"),
      c("17003","17153","17127","17001","17009"),
      c("46081", "46093", "46081","46103","46047","46103","46033"),
      c("46081", "46093", "46081","46103","46047","46103","46033"),
      "37107",
      "37049",
      "37133",
      "37133",
      c("16049"),
      "32007",
      "25003",
      c("32001", "32019", "32027", "32031"),
      "32031",
      c("32019", "32021", "32005", "32031", "32510", "32005", "32019", "32029", "32031", "32510", "32001", "32019", "32027", "32031", "32031"),
      c("39127", "39115", "39009", "39167", "39079", "39105", "39053", "39087"),
      c("39171","39051","39095","39039","39069","39173","39123","39143","39043","39093","39035","39085","39055","39007","39063","39147","39077","39103","39153","39133","39155","39175","39033","39139","39005","39169","39151","39099","39101","39117","39075","39083"),
      c("30029", "30053", "30089", "30029", "30047", "30029", "30047", "30089", "30061", "30063", "30089", "30063", "30081", "30039", "30063", "30081", "30023", "30039", "30077", "30093"),
      c("22117","22007","22093","22095","22057","22089","22087","22109","22057","22051","22075","22087"),
      c("30029", "30047", "30089"),
      c("21075","21105","21039","21007"),
      c("31047","31019","31079","31073","31137","31099"),
      c("31047","31019","31079","31073","31137","31099"),
      c("31047","31019","31079","31073","31137","31099"),
      c("31047","31019","31079","31073","31137","31099"),
      c("22111")
    )
  ) -> fix

data_c_prob %<>% 
  left_join(
    .,
    fix,
    by="EVENT_ID"
  )

data_c_no_prob %<>% 
  mutate(
    FIPS = FIPS_MIX
  )

rbind(
  data_c_prob, 
  data_c_no_prob
) -> c_data_fixed

rbind(
  c_data_fixed,
  no_prob_z_data
) -> data_fixed

setdiff(unlist(data_fixed$FIPS), county_shape$FIPS)

saveRDS(data_fixed,file="data/clean_hail_step2.rds")
